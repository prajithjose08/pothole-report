<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pothole Reporting System</title>
  
  <style>
    /* ---------------------------------------------------------------------- */
    /* GLOBAL STYLES & LAYOUT */
    /* ---------------------------------------------------------------------- */
    :root {
      --color-primary: #3b82f6; /* Blue */
      --color-primary-dark: #1e3a8a; /* Dark Blue */
      --color-background: #f7f7f7; /* Light Gray Background */
      --color-card: #ffffff;
      --color-text-dark: #374151;
      --color-text-light: #6b7280;
      --shadow-soft: 0 10px 30px rgba(0, 0, 0, 0.1);
      --shadow-hover: 0 15px 45px rgba(0, 0, 0, 0.2);
    }

    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--color-background);
      background: linear-gradient(135deg, #e0f2fe 0%, #bfdbfe 100%); /* Softer Blue Gradient */
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start; /* Start from top, not center */
      padding-top: 50px;
    }

    html {
      height: 100%;
    }

    * {
      box-sizing: border-box;
      /* Apply smooth transitions globally for a smooth feel */
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    
    .container {
      width: 90%;
      max-width: 550px; /* Slightly wider for better form use */
      margin: 0 auto;
      padding: 0 20px 50px 20px;
    }

    .wide-container {
      max-width: 1200px;
    }

    .card {
      background: var(--color-card);
      border-radius: 20px;
      padding: 40px;
      box-shadow: var(--shadow-soft);
      animation: fadeIn 0.5s ease-out;
      margin-bottom: 25px;
      border: 1px solid #e5e7eb; /* Subtle border */
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      color: var(--color-primary-dark);
      font-size: 36px;
      margin: 0 0 10px 0;
      font-weight: 800;
    }

    .header p {
      color: var(--color-text-light);
      font-size: 16px;
      margin: 0;
    }

    /* ---------------------------------------------------------------------- */
    /* FORM & INPUTS */
    /* ---------------------------------------------------------------------- */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      background: #e5e7eb;
      padding: 5px;
      border-radius: 15px;
    }

    .tab {
      flex: 1;
      padding: 12px;
      border: none;
      background: transparent;
      color: var(--color-text-light);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      border-radius: 12px;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    .tab.active {
      background: var(--color-card);
      color: var(--color-primary-dark);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      color: var(--color-text-dark);
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 14px 18px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 16px;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      font-family: inherit;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
    }

    .form-group textarea {
      min-height: 120px;
    }

    .submit-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(45deg, var(--color-primary-dark) 0%, var(--color-primary) 100%);
      color: #ffffff;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      margin-top: 10px;
    }

    .submit-btn:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 15px 30px rgba(59, 130, 246, 0.4);
    }

    .submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
    }
    
    .view {
      display: none;
    }

    .view.active {
      display: block;
    }

    /* ---------------------------------------------------------------------- */
    /* NAVIGATION BAR */
    /* ---------------------------------------------------------------------- */
    .nav-bar {
      background: var(--color-card);
      padding: 20px 30px;
      border-radius: 15px;
      margin-bottom: 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow-soft);
      border: 1px solid #e5e7eb;
    }

    .nav-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-avatar {
      width: 55px;
      height: 55px;
      background: linear-gradient(45deg, #1e3a8a 0%, #3b82f6 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 700;
      color: white;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
    }

    .user-details h3 {
      margin: 0;
      color: var(--color-primary-dark);
      font-size: 18px;
    }

    .user-details p {
      margin: 0;
      color: var(--color-text-light);
      font-size: 14px;
    }

    .logout-btn {
      padding: 10px 20px;
      background: #ef4444; /* Red */
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    .logout-btn:hover {
      background: #dc2626;
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
    }

    /* ---------------------------------------------------------------------- */
    /* REPORT CARDS (Citizen & Admin) */
    /* ---------------------------------------------------------------------- */
    .report-card {
      background: #f9fafb;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 15px;
      border-left: 6px solid #e5e7eb; /* Default subtle color */
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    .report-card:hover {
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      transform: translateY(-5px);
    }

    .report-card.high {
      border-left-color: #ef4444; /* Red */
    }

    .report-card.medium {
      border-left-color: #f59e0b; /* Yellow */
    }

    .report-card.low {
      border-left-color: #10b981; /* Green */
    }

    .report-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      border-bottom: 1px dashed #e5e7eb;
      padding-bottom: 10px;
    }

    .report-title {
      font-size: 19px;
      font-weight: 700;
      color: var(--color-primary-dark);
      margin: 0 0 5px 0;
    }

    .report-meta {
      font-size: 13px;
      color: var(--color-text-light);
      margin-top: 5px;
    }

    .status-badge {
      padding: 8px 16px;
      border-radius: 25px;
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .status-pending {
      background: #fef3c7; /* Light Yellow */
      color: #92400e;
    }

    .status-in-progress {
      background: #dbeafe; /* Light Blue */
      color: #1e40af;
    }

    .status-resolved {
      background: #d1fae5; /* Light Green */
      color: #065f46;
    }

    .report-description {
      color: var(--color-text-dark);
      margin: 10px 0;
      line-height: 1.6;
    }

    .report-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .action-btn {
      padding: 10px 18px;
      border: none;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
    }

    .action-btn.resolve {
      background: #10b981; /* Green */
      color: white;
    }

    .action-btn.progress {
      background: #3b82f6; /* Blue */
      color: white;
    }

    .action-btn.delete {
      background: #ef4444; /* Red */
      color: white;
    }

    .action-btn:hover {
      transform: translateY(-2px);
      filter: brightness(1.1);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    /* ---------------------------------------------------------------------- */
    /* ADMIN STATS */
    /* ---------------------------------------------------------------------- */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--color-card);
      padding: 25px;
      border-radius: 15px;
      text-align: center;
      box-shadow: var(--shadow-soft);
      border: 1px solid #e5e7eb;
      transition: all 0.3s;
    }
    
    .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-hover);
    }

    .stat-number {
      font-size: 38px;
      font-weight: 800;
      color: var(--color-primary);
      margin: 0;
    }

    .stat-label {
      font-size: 14px;
      color: var(--color-text-light);
      margin: 5px 0 0 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* ---------------------------------------------------------------------- */
    /* UTILITIES */
    /* ---------------------------------------------------------------------- */
    .message {
      padding: 14px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 15px;
      font-weight: 600;
      display: none;
      opacity: 0;
      transition: opacity 0.5s ease;
    }

    .message.show {
      display: block;
      opacity: 1;
    }

    .message.error {
      background: #fee2e2;
      color: #991b1b;
      border-left: 5px solid #ef4444;
    }

    .message.success {
      background: #d1fae5;
      color: #065f46;
      border-left: 5px solid #10b981;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--color-text-light);
      border: 2px dashed #e5e7eb;
      border-radius: 15px;
      margin-top: 20px;
    }
    
    .empty-icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.7;
    }

    .reports-list {
      max-height: 700px;
      overflow-y: auto;
      padding-right: 10px; /* Space for scrollbar */
    }

    .spinner {
      border: 4px solid #f3f4f6;
      border-top: 4px solid #ffffff; /* White spinner against button background */
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin: 0;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Role Selector */
    .role-option {
      border-radius: 12px;
    }
    .role-option.selected {
      border-color: var(--color-primary);
      background: #eff6ff;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }
    
    /* Filters */
    .filter-btn {
      padding: 10px 18px;
      border-radius: 10px;
    }

    .filter-btn.active {
      border-color: var(--color-primary);
      background: var(--color-primary);
      box-shadow: 0 5px 10px rgba(59, 130, 246, 0.3);
    }
    .filter-btn:hover {
        transform: translateY(-2px);
    }
    
    /* Geolocation button */
    #liveLocationBtn {
        margin-top: 0;
        background: #10b981;
    }
    #liveLocationBtn:hover:not(:disabled) {
        box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4);
    }
    
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <main class="container" id="mainContainer"><div class="view active" id="authView">
    <div class="card">
     <div class="header">
      <h1 id="systemTitle">üöß Pothole Reporting System</h1>
      <p id="welcomeText">Report potholes in your area</p>
     </div>
     <div class="message" id="authMessage"></div>
     <div class="tabs"><button class="tab active" id="loginTab">Login</button> <button class="tab" id="registerTab">Register</button>
     </div><form id="loginForm">
      <div class="form-group"><label for="loginUsername">Username</label> <input type="text" id="loginUsername" required placeholder="Enter your username">
      </div>
      <div class="form-group"><label for="loginPassword">Password</label> <input type="password" id="loginPassword" required placeholder="Enter your password">
      </div><button type="submit" class="submit-btn" id="loginBtn">Login</button>
     </form><form id="registerForm" style="display: none;">
      <div class="form-group"><label for="regFullName">Full Name</label> <input type="text" id="regFullName" required placeholder="John Doe">
      </div>
      <div class="form-group"><label for="regEmail">Email</label> <input type="email" id="regEmail" required placeholder="john@example.com">
      </div>
      <div class="form-group"><label for="regUsername">Username</label> <input type="text" id="regUsername" required placeholder="johndoe">
      </div>
      <div class="form-group"><label for="regPassword">Password</label> <input type="password" id="regPassword" required placeholder="Create a password" minlength="6">
      </div>
      <div class="form-group"><label>Register As</label>
       <div class="role-selector"><label class="role-option selected"> <input type="radio" name="role" value="citizen" checked> <span class="role-label">üë§ Citizen</span> <span class="role-description">Report potholes</span> </label> <label class="role-option"> <input type="radio" name="role" value="admin"> <span class="role-label">üë®‚Äçüíº Admin</span> <span class="role-description">Manage reports</span> </label>
       </div>
      </div><button type="submit" class="submit-btn" id="registerBtn">Create Account</button>
     </form>
    </div>
   </div><div class="view" id="citizenView">
    <div class="nav-bar">
     <div class="nav-info">
      <div class="user-avatar" id="citizenAvatar">
       U
      </div>
      <div class="user-details">
       <h3 id="citizenName">User</h3>
       <p>Citizen Dashboard</p>
      </div>
     </div><button class="logout-btn" id="citizenLogout">Logout</button>
    </div>
    <div class="card">
     <div class="header">
      <h1>Report a Pothole</h1>
      <p>Help us fix roads in your community</p>
     </div>
     <div class="message" id="reportMessage"></div>
     <form id="reportForm">
      <div class="form-group"><label for="reportLocation">Location</label> <input type="text" id="reportLocation" required placeholder="Street name or address">
      </div>
      <button type="button" class="submit-btn success-btn" id="liveLocationBtn">üìç Get Current Location</button>
      <div class="form-group" style="margin-top: 20px;"><label for="reportDescription">Description</label> <textarea id="reportDescription" required placeholder="Describe the pothole (size, depth, hazards, etc.)"></textarea>
      </div>
      <div class="form-group"><label for="reportSeverity">Severity Level</label> <select id="reportSeverity" required> <option value="low">Low - Minor damage</option> <option value="medium">Medium - Moderate damage</option> <option value="high">High - Severe damage</option> </select>
      </div>
      <div class="form-group"><label for="reportImage">Image Description (Optional)</label> <input type="text" id="reportImage" placeholder="Describe what the pothole looks like">
      </div><button type="submit" class="submit-btn" id="submitReportBtn">Submit Report</button>
     </form>
    </div>
    <div class="card">
     <div class="header">
      <h1>My Reports</h1>
      <p>Track your submitted reports</p>
     </div>
     <div class="reports-list" id="citizenReports"></div>
    </div>
   </div><div class="view" id="adminView">
    <div class="nav-bar">
     <div class="nav-info">
      <div class="user-avatar" id="adminAvatar">
       A
      </div>
      <div class="user-details">
       <h3 id="adminName">Admin</h3>
       <p>Admin Dashboard</p>
      </div>
     </div><button class="logout-btn" id="adminLogout">Logout</button>
    </div>
    <div class="stats-grid">
     <div class="stat-card">
      <p class="stat-number" id="totalReports">0</p>
      <p class="stat-label">Total Reports</p>
     </div>
     <div class="stat-card">
      <p class="stat-number" id="pendingReports">0</p>
      <p class="stat-label">Pending</p>
     </div>
     <div class="stat-card">
      <p class="stat-number" id="progressReports">0</p>
      <p class="stat-label">In Progress</p>
     </div>
     <div class="stat-card">
      <p class="stat-number" id="resolvedReports">0</p>
      <p class="stat-label">Resolved</p>
     </div>
    </div>
    <div class="card">
     <div class="header">
      <h1>All Reports</h1>
      <p>Manage pothole reports from citizens</p>
     </div>
     <div class="filter-bar"><button class="filter-btn active" data-filter="all">All</button> <button class="filter-btn" data-filter="pending">Pending</button> <button class="filter-btn" data-filter="in-progress">In Progress</button> <button class="filter-btn" data-filter="resolved">Resolved</button>
     </div>
     <div class="message" id="adminMessage"></div>
     <div class="reports-list" id="adminReports"></div>
    </div>
   </div>
  </main>
  <script>
    // --- Global State ---
    let allData = { users: [], reports: [] }; // Data is now structured
    let currentUser = null;
    let currentFilter = 'all';
    let isSystemReady = false; 

    // --- Configuration (Element SDK is ignored as it's not server-based) ---
    const defaultConfig = {
      system_title: "üöß Pothole Reporting System (MongoDB)",
      welcome_text: "Report potholes in your area"
    };

    // --- API & Utility Functions ---
    const API_BASE_URL = 'http://localhost:3000/api';

    function showMessage(elementId, message, type) {
      const el = document.getElementById(elementId);
      el.textContent = message;
      el.className = `message show ${type}`;
      setTimeout(() => el.classList.remove('show'), 5000);
    }

    // Function to fetch ALL reports
    async function fetchAllData() {
      try {
        const reportsResponse = await fetch(`${API_BASE_URL}/reports`);
        if (!reportsResponse.ok) throw new Error('Failed to fetch reports');
        
        const reports = await reportsResponse.json();
        allData.reports = reports;

        // Re-render the appropriate view after data changes
        if (currentUser) {
          if (currentUser.role === 'citizen') {
            renderCitizenReports();
          } else if (currentUser.role === 'admin') {
            renderAdminDashboard();
          }
        }
      } catch (error) {
        console.error("Failed to fetch data from API:", error);
        // Only show message if we're trying to render the dashboard, not just initialization
        if (currentUser) {
             showMessage('authMessage', 'Failed to refresh data from backend server.', 'error');
        }
      }
    }
    
    function getReports() {
        return allData.reports;
    }

    // --- Geolocation (No change needed) ---

    function getCurrentLocation() {
        const locationInput = document.getElementById('reportLocation');
        const locationBtn = document.getElementById('liveLocationBtn');
        const originalBtnHtml = locationBtn.innerHTML;

        if (!navigator.geolocation) {
            showMessage('reportMessage', 'Geolocation is not supported by your browser.', 'error');
            return;
        }

        locationBtn.disabled = true;
        locationBtn.innerHTML = '<div class="spinner"></div>'; 

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude.toFixed(6);
                const lon = position.coords.longitude.toFixed(6);
                locationInput.value = `GPS: Lat ${lat}, Lon ${lon}`;
                showMessage('reportMessage', 'Location fetched successfully!', 'success');
                
                locationBtn.disabled = false;
                locationBtn.innerHTML = originalBtnHtml;
            },
            (error) => {
                let errorMessage;
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = "User denied the request for Geolocation. Please allow location access in your browser settings.";
                        break;
                    case error.TIMEOUT:
                        errorMessage = "The request to get user location timed out.";
                        break;
                    case error.POSITION_UNAVAILABLE:
                    default:
                        errorMessage = "Location information is unavailable.";
                        break;
                }
                showMessage('reportMessage', errorMessage, 'error');

                locationBtn.disabled = false;
                locationBtn.innerHTML = originalBtnHtml;
            }
        );
    }

    // --- App Initialization ---
    async function initializeApp() {
      // Set titles
      document.getElementById('systemTitle').textContent = defaultConfig.system_title;
      document.getElementById('welcomeText').textContent = defaultConfig.welcome_text;
      
      // Attempt an initial data fetch to check server connectivity
      try {
          // This call is mainly to check if the server is up and prevent running frontend if not
          const response = await fetch(`${API_BASE_URL}/reports`);
          if (!response.ok) {
              throw new Error('Server unreachable or API error during init.');
          }
          const reports = await response.json();
          allData.reports = reports;
          
          isSystemReady = true; 
          document.getElementById('liveLocationBtn')?.addEventListener('click', getCurrentLocation);
      } catch (e) {
          showMessage('authMessage', 'System failed to connect to the backend server. Is "node server.js" running?', 'error');
      }
    }
    
    // --- View Switching ---
    function switchView(viewId) {
      if (document.startViewTransition) {
        document.startViewTransition(() => {
          document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
          document.getElementById(viewId).classList.add('active');
          if (viewId === 'citizenView' || viewId === 'adminView') {
            document.getElementById('mainContainer').classList.add('wide-container');
          } else {
            document.getElementById('mainContainer').classList.remove('wide-container');
          }
        });
      } else {
          document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
          document.getElementById(viewId).classList.add('active');
          if (viewId === 'citizenView' || viewId === 'adminView') {
            document.getElementById('mainContainer').classList.add('wide-container');
          } else {
            document.getElementById('mainContainer').classList.remove('wide-container');
          }
      }
    }

    // --- Auth View Logic ---
    document.getElementById('loginTab').addEventListener('click', () => {
      document.getElementById('loginTab').classList.add('active');
      document.getElementById('registerTab').classList.remove('active');
      document.getElementById('loginForm').style.display = 'block';
      document.getElementById('registerForm').style.display = 'none';
      document.getElementById('authMessage').textContent = '';
    });

    document.getElementById('registerTab').addEventListener('click', () => {
      document.getElementById('registerTab').classList.add('active');
      document.getElementById('loginTab').classList.remove('active');
      document.getElementById('registerForm').style.display = 'block';
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('authMessage').textContent = '';
    });

    // Role selector
    document.querySelectorAll('.role-option').forEach(option => {
      option.addEventListener('click', () => {
        document.querySelectorAll('.role-option').forEach(o => o.classList.remove('selected'));
        option.classList.add('selected');
        option.querySelector('input[type="radio"]').checked = true;
      });
    });

    // Login (UPDATED TO USE FETCH)
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      const btn = document.getElementById('loginBtn');
      
      if (!isSystemReady) {
          showMessage('authMessage', 'System is not initialized. Please refresh.', 'error');
          return;
      }
      
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner"></div>';

      try {
        const response = await fetch(`${API_BASE_URL}/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });
        
        const result = await response.json();

        if (response.ok) {
          currentUser = result.user; // Get user details from the server response
          await fetchAllData(); // Refresh reports after successful login
          
          if (currentUser.role === 'citizen') {
            showCitizenDashboard(currentUser);
          } else {
            showAdminDashboard(currentUser);
          }
        } else {
          showMessage('authMessage', result.error || 'Login failed.', 'error');
        }
      } catch (error) {
        showMessage('authMessage', 'Server connection error during login.', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Login';
      }
    });

    // Register (UPDATED TO USE FETCH)
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btn = document.getElementById('registerBtn');
      
      if (!isSystemReady) {
          showMessage('authMessage', 'System is not initialized. Please refresh.', 'error');
          return;
      }

      const fullName = document.getElementById('regFullName').value.trim();
      const email = document.getElementById('regEmail').value.trim();
      const username = document.getElementById('regUsername').value.trim();
      const password = document.getElementById('regPassword').value;
      const role = document.querySelector('input[name="role"]:checked').value;
      
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner"></div>';
      
      const newUser = { fullName, email, username, password, role };

      try {
        const response = await fetch(`${API_BASE_URL}/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(newUser)
        });
        
        const result = await response.json();

        if (response.ok) {
          showMessage('authMessage', 'Account created successfully! Please login.', 'success');
          document.getElementById('registerForm').reset();
          document.querySelectorAll('.role-option').forEach(o => o.classList.remove('selected'));
          document.querySelector('.role-option').classList.add('selected');
          document.querySelector('input[name="role"][value="citizen"]').checked = true;
          
          setTimeout(() => {
            document.getElementById('loginTab').click();
          }, 1500);
        } else {
          showMessage('authMessage', result.error || 'Registration failed.', 'error');
        }
      } catch (error) {
        showMessage('authMessage', 'Server connection error during registration.', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Create Account';
      }
    });

    // --- Citizen Dashboard ---

    function showCitizenDashboard(user) {
      switchView('citizenView');
      const initials = user.fullName.split(' ').map(n => n[0]).join('').toUpperCase();
      document.getElementById('citizenAvatar').textContent = initials;
      document.getElementById('citizenName').textContent = user.fullName;
      renderCitizenReports();
    }

    function renderCitizenReports() {
      if (!currentUser) return;
      
      // Filter based on the current data fetched from the API
      // The MongoDB Report schema uses _id for ID, and reportedBy matches username
      const reports = getReports().filter(r => r.reportedBy === currentUser.username); 
      const container = document.getElementById('citizenReports');
      
      if (reports.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üìù</div>
            <h3>No Reports Yet</h3>
            <p>Submit your first pothole report above</p>
          </div>
        `;
        return;
      }

      container.innerHTML = reports.sort((a, b) => new Date(b.reportedAt) - new Date(a.reportedAt)).map(report => `
        <div class="report-card ${report.severity}">
          <div class="report-header">
            <div>
              <h3 class="report-title">${report.location}</h3>
              <p class="report-meta">Reported ${new Date(report.reportedAt).toLocaleDateString()}</p>
            </div>
            <span class="status-badge status-${report.status}">${report.status.replace('-', ' ')}</span>
          </div>
          <p class="report-description">${report.description}</p>
          ${report.imageDescription ? `<p class="report-meta">üì∑ ${report.imageDescription}</p>` : ''}
          <p class="report-meta"><strong>Severity:</strong> ${report.severity.toUpperCase()}</p>
        </div>
      `).join('');
    }

    // Submit Report (UPDATED TO USE FETCH)
    document.getElementById('reportForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (!isSystemReady) {
          showMessage('reportMessage', 'System is not ready.', 'error');
          return;
      }

      const location = document.getElementById('reportLocation').value.trim();
      const description = document.getElementById('reportDescription').value.trim();
      const severity = document.getElementById('reportSeverity').value;
      const imageDescription = document.getElementById('reportImage').value.trim();
      const btn = document.getElementById('submitReportBtn');
      
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner"></div>';

      const newReport = {
        location,
        description,
        severity,
        imageDescription,
        reportedBy: currentUser.username, // Use the logged-in username
      };

      try {
        const response = await fetch(`${API_BASE_URL}/reports`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(newReport)
        });
        
        const result = await response.json();

        if (response.ok) {
          showMessage('reportMessage', 'Report submitted successfully!', 'success');
          document.getElementById('reportForm').reset();
          await fetchAllData(); // Refresh list to show new report
        } else {
          showMessage('reportMessage', result.error || 'Failed to submit report.', 'error');
        }
      } catch (error) {
        showMessage('reportMessage', 'Server connection error during report submission.', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Submit Report';
      }
    });

    // --- Admin Dashboard ---

    function showAdminDashboard(user) {
      switchView('adminView');
      const initials = user.fullName.split(' ').map(n => n[0]).join('').toUpperCase();
      document.getElementById('adminAvatar').textContent = initials;
      document.getElementById('adminName').textContent = user.fullName;
      renderAdminDashboard();
    }

    function renderAdminDashboard() {
      // Data is always up-to-date from fetchAllData() called on login/actions
      const reports = getReports();
      
      // Update stats
      document.getElementById('totalReports').textContent = reports.length;
      document.getElementById('pendingReports').textContent = reports.filter(r => r.status === 'pending').length;
      document.getElementById('progressReports').textContent = reports.filter(r => r.status === 'in-progress').length;
      document.getElementById('resolvedReports').textContent = reports.filter(r => r.status === 'resolved').length;
      
      renderAdminReports();
    }

    function renderAdminReports() {
      const reports = getReports();
      const container = document.getElementById('adminReports');
      
      let filteredReports = reports;
      if (currentFilter !== 'all') {
        filteredReports = reports.filter(r => r.status === currentFilter);
      }
      
      if (filteredReports.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üìã</div>
            <h3>No Reports Found</h3>
            <p>No reports match the current filter</p>
          </div>
        `;
        return;
      }

      // MongoDB reports use _id
      container.innerHTML = filteredReports.sort((a, b) => new Date(b.reportedAt) - new Date(a.reportedAt)).map(report => `
        <div class="report-card ${report.severity}">
          <div class="report-header">
            <div>
              <h3 class="report-title">${report.location}</h3>
              <p class="report-meta">By ${report.reportedBy} ‚Ä¢ ${new Date(report.reportedAt).toLocaleDateString()}</p>
            </div>
            <span class="status-badge status-${report.status}">${report.status.replace('-', ' ')}</span>
          </div>
          <p class="report-description">${report.description}</p>
          ${report.imageDescription ? `<p class="report-meta">üì∑ ${report.imageDescription}</p>` : ''}
          <p class="report-meta"><strong>Severity:</strong> ${report.severity.toUpperCase()}</p>
          ${report.resolvedAt ? `<p class="report-meta">‚úÖ Resolved on ${new Date(report.resolvedAt).toLocaleDateString()}</p>` : ''}
          <div class="report-actions">
            ${report.status !== 'in-progress' ? `<button class="action-btn progress" onclick="updateReportStatus('${report._id}', 'in-progress')">Mark In Progress</button>` : ''}
            ${report.status !== 'resolved' ? `<button class="action-btn resolve" onclick="updateReportStatus('${report._id}', 'resolved')">Mark Resolved</button>` : ''}
            <button class="action-btn delete" onclick="deleteReport('${report._id}')">Delete</button>
          </div>
        </div>
      `).join('');
    }

    // Filter buttons (No change needed)
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        renderAdminReports();
      });
    });

    // Update Report Status (UPDATED TO USE FETCH)
    window.updateReportStatus = async function(reportId, newStatus) {
      if (!isSystemReady) {
          showMessage('adminMessage', 'System is not ready.', 'error');
          return;
      }

      try {
        const response = await fetch(`${API_BASE_URL}/reports/${reportId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: newStatus })
        });

        if (response.ok) {
          showMessage('adminMessage', `Report ${newStatus.replace('-', ' ')}`, 'success');
          await fetchAllData(); // Refresh data after update
        } else {
          const result = await response.json();
          showMessage('adminMessage', result.error || 'Failed to update report', 'error');
        }
      } catch (error) {
         showMessage('adminMessage', 'Server connection error during status update.', 'error');
      }
    };

    // Delete Report (UPDATED TO USE FETCH)
    window.deleteReport = async function(reportId) {
      if (!isSystemReady) {
          showMessage('adminMessage', 'System is not ready.', 'error');
          return;
      }

      if (!confirm("Are you sure you want to delete this report?")) return;

      try {
        const response = await fetch(`${API_BASE_URL}/reports/${reportId}`, {
            method: 'DELETE',
        });

        if (response.ok) {
          showMessage('adminMessage', 'Report deleted', 'success');
          await fetchAllData(); // Refresh data after deletion
        } else {
          const result = await response.json();
          showMessage('adminMessage', result.error || 'Failed to delete report', 'error');
        }
      } catch (error) {
         showMessage('adminMessage', 'Server connection error during deletion.', 'error');
      }
    };

    // Logout (No change needed)
    document.getElementById('citizenLogout').addEventListener('click', () => {
      currentUser = null;
      switchView('authView');
      document.getElementById('loginForm').reset();
    });

    document.getElementById('adminLogout').addEventListener('click', () => {
      currentUser = null;
      currentFilter = 'all';
      switchView('authView');
      document.getElementById('loginForm').reset();
    });

    // Initialize
    initializeApp();
  </script>
 </body>
</html>